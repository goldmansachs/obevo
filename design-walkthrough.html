<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2020-06-22 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20200622" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Obevo &#x2013; Design Walkthrough</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
      <script type="text/javascript" src="./js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                      <a href="https://github.com/goldmansachs/obevo">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="index.html" title="Intro">Intro</a></li>
            <li><a href="overview.html" title="Overview">Overview</a></li>
            <li><a href="setup.html" title="Setup">Setup</a></li>
            <li><a href="support.html" title="Help and Support">Help and Support</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Technical Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="db-project-structure.html" title="DB Project Structure">DB Project Structure</a></li>
            <li><a href="environment-management.html" title="Environment Management">Environment Management</a></li>
            <li><a href="permission-management.html" title="Permission Management">Permission Management</a></li>
            <li><a href="error-handling.html" title="Error-Handling">Error-Handling</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">API Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="command-line-api.html" title="Command-line API">Command-line API</a></li>
            <li><a href="java-api.html" title="Java API">Java API</a></li>
            <li><a href="maven-api.html" title="Maven plugin API">Maven plugin API</a></li>
            <li><a href="gradle-api.html" title="Gradle API">Gradle API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Advanced Topics <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="db-project-best-practices.html" title="DB Project Best Practices">DB Project Best Practices</a></li>
            <li><a href="rollback.html" title="Rollback">Rollback</a></li>
            <li><a href="multiple-schema-management.html" title="Multiple Schema Management">Multiple Schema Management</a></li>
            <li><a href="schema-and-config-packaging.html" title="Separate Schema and Config Packaging">Separate Schema and Config Packaging</a></li>
            <li><a href="in-memory-db-testing.html" title="In-memory DB Testing">In-memory DB Testing</a></li>
            <li><a href="parallel-deploy-execution.html" title="Parallel Deploy Execution">Parallel Deploy Execution</a></li>
            <li><a href="orm-integration.html" title="ORM Integration">ORM Integration</a></li>
            <li><a href="baseline-validation.html" title="Baseline DDL Validation">Baseline DDL Validation</a></li>
            <li><a href="phased-deployments.html" title="Phased Deployments">Phased Deployments</a></li>
            <li><a href="incremental-change-code-cleanup.html" title="Incremental Change Code Cleanup">Incremental Change Code Cleanup</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Platform-Specific Details <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="platform-listing.html" title="Platform Listing">Platform Listing</a></li>
            <li><a href="db2-notes.html" title="DB2">DB2</a></li>
            <li><a href="general-db-notes.html" title="HSQLDB">HSQLDB</a></li>
            <li><a href="general-db-notes.html" title="H2">H2</a></li>
            <li><a href="mongodb-notes.html" title="MongoDB">MongoDB</a></li>
            <li><a href="oracle-notes.html" title="Oracle">Oracle</a></li>
            <li><a href="postgresql-notes.html" title="PostgreSQL">PostgreSQL</a></li>
            <li><a href="redshift-notes.html" title="Redshift">Redshift</a></li>
            <li><a href="sybase-ase-notes.html" title="SQL Server">SQL Server</a></li>
            <li><a href="sybase-ase-notes.html" title="Sybase ASE">Sybase ASE</a></li>
            <li><a href="general-db-notes.html" title="Sybase IQ">Sybase IQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Onboarding Guide <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="onboarding-guide.html" title="Which onboarding to choose?">Which onboarding to choose?</a></li>
            <li><a href="new-onboarding-guide.html" title="New Systems">New Systems</a></li>
            <li><a href="existing-onboarding-guide.html" title="Existing Systems">Existing Systems</a></li>
            <li><a href="existing-diverging-onboarding-guide.html" title="Existing Systems with Diverging Shards">Existing Systems with Diverging Shards</a></li>
            <li><a href="legacy-onboarding-guide.html" title="Legacy Onboarding - Legacy Systems">Legacy Onboarding - Legacy Systems</a></li>
            <li><a href="db-merge-tool.html" title="DB Merge Tool">DB Merge Tool</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developer Information <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="developer-guide.html" title="Developer Guide">Developer Guide</a>
              <ul class="dropdown-menu">
                  <li><a href="dev-setup-docker.html" title="Docker-based Test DB Setup">Docker-based Test DB Setup</a></li>
                  <li><a href="dev-setup-amazon.html" title="Amazon RDS DB Setup">Amazon RDS DB Setup</a></li>
                  <li><a href="dev-setup-sybase-ase.html" title="Sybase ASE Test DB Setup">Sybase ASE Test DB Setup</a></li>
              </ul>
            </li>
            <li><a href="design-walkthrough.html" title="Design Walkthrough">Design Walkthrough</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="./" id="bannerLeft"><h2>Obevo</h2>
</a></div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li class=""><a href="./" title="Obevo">Obevo</a><span class="divider">/</span></li>
    <li class="active ">Design Walkthrough</li>
        <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2020-06-22</li>
          <li id="projectVersion" class="pull-right">Version: 8.2.0</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Getting Started</li>
    <li><a href="index.html" title="Intro"><span class="none"></span>Intro</a>  </li>
    <li><a href="overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="setup.html" title="Setup"><span class="none"></span>Setup</a>  </li>
    <li><a href="support.html" title="Help and Support"><span class="none"></span>Help and Support</a>  </li>
          <li class="nav-header">Technical Documentation</li>
    <li><a href="db-project-structure.html" title="DB Project Structure"><span class="none"></span>DB Project Structure</a>  </li>
    <li><a href="environment-management.html" title="Environment Management"><span class="none"></span>Environment Management</a>  </li>
    <li><a href="permission-management.html" title="Permission Management"><span class="none"></span>Permission Management</a>  </li>
    <li><a href="error-handling.html" title="Error-Handling"><span class="none"></span>Error-Handling</a>  </li>
          <li class="nav-header">API Documentation</li>
    <li><a href="command-line-api.html" title="Command-line API"><span class="none"></span>Command-line API</a>  </li>
    <li><a href="java-api.html" title="Java API"><span class="none"></span>Java API</a>  </li>
    <li><a href="maven-api.html" title="Maven plugin API"><span class="none"></span>Maven plugin API</a>  </li>
    <li><a href="gradle-api.html" title="Gradle API"><span class="none"></span>Gradle API</a>  </li>
          <li class="nav-header">Advanced Topics</li>
    <li><a href="db-project-best-practices.html" title="DB Project Best Practices"><span class="none"></span>DB Project Best Practices</a>  </li>
    <li><a href="rollback.html" title="Rollback"><span class="none"></span>Rollback</a>  </li>
    <li><a href="multiple-schema-management.html" title="Multiple Schema Management"><span class="none"></span>Multiple Schema Management</a>  </li>
    <li><a href="schema-and-config-packaging.html" title="Separate Schema and Config Packaging"><span class="none"></span>Separate Schema and Config Packaging</a>  </li>
    <li><a href="in-memory-db-testing.html" title="In-memory DB Testing"><span class="none"></span>In-memory DB Testing</a>  </li>
    <li><a href="parallel-deploy-execution.html" title="Parallel Deploy Execution"><span class="none"></span>Parallel Deploy Execution</a>  </li>
    <li><a href="orm-integration.html" title="ORM Integration"><span class="none"></span>ORM Integration</a>  </li>
    <li><a href="baseline-validation.html" title="Baseline DDL Validation"><span class="none"></span>Baseline DDL Validation</a>  </li>
    <li><a href="phased-deployments.html" title="Phased Deployments"><span class="none"></span>Phased Deployments</a>  </li>
    <li><a href="incremental-change-code-cleanup.html" title="Incremental Change Code Cleanup"><span class="none"></span>Incremental Change Code Cleanup</a>  </li>
          <li class="nav-header">Platform-Specific Details</li>
    <li><a href="platform-listing.html" title="Platform Listing"><span class="none"></span>Platform Listing</a>  </li>
    <li><a href="db2-notes.html" title="DB2"><span class="none"></span>DB2</a>  </li>
    <li><a href="general-db-notes.html" title="HSQLDB"><span class="none"></span>HSQLDB</a>  </li>
    <li><a href="general-db-notes.html" title="H2"><span class="none"></span>H2</a>  </li>
    <li><a href="mongodb-notes.html" title="MongoDB"><span class="none"></span>MongoDB</a>  </li>
    <li><a href="oracle-notes.html" title="Oracle"><span class="none"></span>Oracle</a>  </li>
    <li><a href="postgresql-notes.html" title="PostgreSQL"><span class="none"></span>PostgreSQL</a>  </li>
    <li><a href="redshift-notes.html" title="Redshift"><span class="none"></span>Redshift</a>  </li>
    <li><a href="sybase-ase-notes.html" title="SQL Server"><span class="none"></span>SQL Server</a>  </li>
    <li><a href="sybase-ase-notes.html" title="Sybase ASE"><span class="none"></span>Sybase ASE</a>  </li>
    <li><a href="general-db-notes.html" title="Sybase IQ"><span class="none"></span>Sybase IQ</a>  </li>
          <li class="nav-header">Onboarding Guide</li>
    <li><a href="onboarding-guide.html" title="Which onboarding to choose?"><span class="none"></span>Which onboarding to choose?</a>  </li>
    <li><a href="new-onboarding-guide.html" title="New Systems"><span class="none"></span>New Systems</a>  </li>
    <li><a href="existing-onboarding-guide.html" title="Existing Systems"><span class="none"></span>Existing Systems</a>  </li>
    <li><a href="existing-diverging-onboarding-guide.html" title="Existing Systems with Diverging Shards"><span class="none"></span>Existing Systems with Diverging Shards</a>  </li>
    <li><a href="legacy-onboarding-guide.html" title="Legacy Onboarding - Legacy Systems"><span class="none"></span>Legacy Onboarding - Legacy Systems</a>  </li>
    <li><a href="db-merge-tool.html" title="DB Merge Tool"><span class="none"></span>DB Merge Tool</a>  </li>
          <li class="nav-header">Developer Information</li>
    <li><a href="developer-guide.html" title="Developer Guide"><span class="icon-chevron-down"></span>Developer Guide</a>
      <ul class="nav nav-list">
    <li><a href="dev-setup-docker.html" title="Docker-based Test DB Setup"><span class="none"></span>Docker-based Test DB Setup</a>  </li>
    <li><a href="dev-setup-amazon.html" title="Amazon RDS DB Setup"><span class="none"></span>Amazon RDS DB Setup</a>  </li>
    <li><a href="dev-setup-sybase-ase.html" title="Sybase ASE Test DB Setup"><span class="none"></span>Sybase ASE Test DB Setup</a>  </li>
      </ul>
  </li>
    <li class="active"><a href="#"><span class="none"></span>Design Walkthrough</a>
  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--

    Copyright 2017 Goldman Sachs.
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

--><h1>Design Walkthrough</h1>

<ul>
<li><a href="#InfoQ_Article">InfoQ Article</a></li>
<li><a href="#Obevo_Problem_Statement_-_A_Compiler_for_Stateful_and_Stateless_Code_Classes">Obevo Problem Statement - A Compiler for Stateful and Stateless Code Classes</a></li>
<li><a href="#Problem_Terminology">Problem Terminology</a></li>
<li><a href="#Requirements_for_Stateful_objects__run-once_statements">Requirements for Stateful objects / run-once statements</a></li>
<li><a href="#Deployment_Algorithm">Deployment Algorithm</a></li>
<li><a href="#Source_Code_Format">Source Code Format</a></li>
<li><a href="#Sorting_Changes_in_the_file-per-object_format">Sorting Changes in the file-per-object format</a></li>
<li><a href="#Defining_and_discovering_dependencies_in_Source_Code">Defining and discovering dependencies in Source Code</a></li>
<li><a href="#Putting_it_together_-_integrating_DB_Deployments_and_Other_Platforms">Putting it together - integrating DB Deployments and Other Platforms</a></li></ul>
<div class="section">
<h2><a name="InfoQ_Article"></a>InfoQ Article</h2>
<p>Note: we have published an <a class="externalLink" href="https://www.infoq.com/articles/Obevo-Introduction">article on InfoQ</a> that gives an overview of Obevo and some technical details.</p>
<p>The InfoQ article has a slightly more up-to-date and cleaner representation of some of the information on this page. Feel free to look at the InfoQ article first before proceeding on this page.</p></div>
<div class="section">
<h2><a name="Obevo_Problem_Statement_-_A_Compiler_for_Stateful_and_Stateless_Code_Classes"></a>Obevo Problem Statement - A Compiler for Stateful and Stateless Code Classes</h2>
<p>Design goal of Obevo - to give idempotent deploy semantics onto a platform target that does not have it by default, the keys problem to solve being:</p>

<ol style="list-style-type: decimal">
  
<li>There is no existing mechanism to take a full binary of code and deploy it to upgrade an environment</li>
  
<li>Some objects within the environment are stateful, thus requiring incremental commands to modify them (and making #1 difficult)</li>
  
<li>There is no default ordering mechanism for object changes to the environment; must be manually defined by users.</li>
</ol>
<p>Databases happen to hit all 3 points, notably for applying SQL DDL changes to DB schemas, per <a href="overview.html">the overview</a></p>

<ul>
  
<li>#1: There is no mechanism currently defined by DBMS providers to define a full schema definition in source code and apply the results to a database that can work both against a blank and existing db</li>
  
<li>#2a: Table modifications cannot be expressed by simply presenting a full view of the object definition. Instead, one must provide an incremental modification statement to alter the table, and changes should only be applied once, lest an exception is hit or data applied in duplicate.</li>
  
<li>#2b: At the same time, other DB objects are stateless (unlike tables), where one can simply drop and add objects to recreate them. Such objects like stored procedures and views share semantics more similar to application code.</li>
  
<li>#3:When deploying a full database, order must be considered to deploy dependency objects before the ones depending on them (e.g. deploying a table before the view that depends on it.</li>
</ul>
<p>Noting point #2, each object type (stateful vs. stateless) have different ways to maintain them, and a tool should ideally be able to handle them both. This is the premise and value-add of Obevo.</p>
<p>Boiling down the core problem and design - it actually does not involve SQL or DB constructs at all. Instead, it is about managing code files in the stateless and stateful manners and applying changes to them to the target environment. The end result is a &#x201c;mini-compiler&#x201d; of sorts; hence, the title of this section.</p>
<p>This page details the generic pattern here on compiling stateful and stateless code for an underlying system that only accepts incremental changes. As of today, the implementations have been around RDBMS, but we&#x2019;ve already started to venture into NoSQL where not all operations need SQL (Hive), and depending on the creative minds out there, we can apply this to more.</p>
<p><i>So yes, this is a solution looking for a problem :) - but an interesting problem it is!</i></p></div>
<div class="section">
<h2><a name="Problem_Terminology"></a>Problem Terminology</h2>
<p>Let&#x2019;s lay out the main actor involved in a System, at least with regards to this problem statement:</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th>Actor </th>
      
<th>Role Description Equivalent for a database setup </th>
      
<th>Equivalent for an application setup (Java)</th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td>Developers </td>
      
<td>The folks building the System Developers </td>
      
<td>Developers</td>
    </tr>
    
<tr class="a">
      
<td>Source Code </td>
      
<td>The code that Developers write that is eventually built, shipped, and run to provide functionality to a user. But first, it must be put into a form that can be run... DDLs, SQL scripts, etc. </td>
      
<td>Java classes</td>
    </tr>
    
<tr class="b">
      
<td>Artifact / Binary </td>
      
<td>The result of building the source code into something that can be run. zip archive containing the SQL scripts to deploy </td>
      
<td>Java Jar</td>
    </tr>
    
<tr class="a">
      
<td>Environment </td>
      
<td>An instance of a running System (i.e. where the end result of a Source Code build is run). A system can have many Environments, from dev to uat to production. A database / set of databases on some known schemas </td>
      
<td>A host with a container to execute Java processes</td>
    </tr>
    
<tr class="b">
      
<td>Deploy Tool </td>
      
<td>The mechanism that applies a built binary to an Environment A SQL command-line interface, or a deploy tool like Obevo </td>
      
<td>General install scripts, FTP, whatever your firm uses</td>
    </tr>
    
<tr class="a">
      
<td>Deploy Team </td>
      
<td>The individuals that carry out the deployment (i.e. invoke whatever commands or UIs to carry out the deployment using the tool Team member/s assigned to this role </td>
      
<td>Team member/s assigned to this role</td>
    </tr>
  </tbody>
</table></div>
<div class="section">
<h2><a name="Requirements_for_Stateful_objects__run-once_statements"></a>Requirements for Stateful objects / run-once statements</h2>
<p>For any given deployment activity, a set of statements need to be applied to a target environment.</p>
<p>As mentioned earlier, statements on stateful objects must only be run once, and the state of an environment over time is the accumulation of such statements applied to it.</p>
<p>e.g.</p>

<ul>
  
<li>Binary Version 1 - apply statements 1, 2, 3</li>
  
<li>Binary Version 2 - apply statements 4, 5</li>
  
<li>Binary Version 3 - apply statements 6, 7, 8</li>
</ul>
<p>We present two ways to do this:</p>

<ol style="list-style-type: decimal">
  
<li>The Deploy Team notes which statement/s from the Source Code need to be applied for that migration</li>
  
<li>The Deploy Tool takes the full set of statements from the Source Code and figures out which ones need to be applied to the environment</li>
</ol>
<p>Option 1 was the way teams did this without automation. Tooling-wise, it is quite simple; but it is a riskier endeavor as it leaves more responsibility on a human operator.</p>
<p>Option 2 is what most database deployment tools do. We detail that now.</p></div>
<div class="section">
<h2><a name="Deployment_Algorithm"></a>Deployment Algorithm</h2>
<div class="section">
<h3><a name="Diagram"></a>Diagram</h3>
<p><img src="images/algo-overview.jpg" alt="Deploy Algorithm" /></p>
<p>Developer Guide note:</p>

<ol style="list-style-type: decimal">
  
<li>Algorithm in this diagram is implemented in <b>com.gs.obevo.impl.MainDeployer</b></li>
  
<li>Deploy Log in the diagram maps to <b>com.gs.obevo.api.platform.ChangeAuditDao</b></li>
  
<li>Enviroment in the diagram maps to <b>com.gs.obevo.api.appdata.Environment</b></li>
  
<li>Changeset in the diagram maps to <b>com.gs.obevo.impl.Changeset</b></li>
  
<li>Step 1) to read Source Code changes is done in <b>com.gs.obevo.impl.SourceChangeReader</b></li>
</ol>
<p>Recapping the steps in the diagram:</p>

<ol style="list-style-type: decimal">
  
<li>Read Changes in Source Code</li>
  
<li>Read Changes from Deploy Log</li>
  
<li>Calculate ChangeSet between Source Code and Deploy Log</li>
  
<li>Apply Changeset to Environment and Deploy Log</li>
</ol>
<p>Details on some of these steps:</p></div>
<div class="section">
<h3><a name="ChangeKey_to_match_Source_Code_and_Deploy_Log"></a>ChangeKey to match Source Code and Deploy Log</h3>
<p>Step 3 is to calculate the ChangeSet between the Source Code and Deploy Log. This implies some kind of key that can identify a Change to facilitate this match. The choice of type to use (e.g. number, string) does not matter.</p>
<p>The ChangeKey will be stored in the Deploy Log when applying the change so that it can be used later.</p></div>
<div class="section">
<h3><a name="Stateful_Changes:_No_modifying_or_deleting_already_deployed_changes_allowed"></a>Stateful Changes: No modifying or deleting already deployed changes allowed</h3>
<p>As mentioned earlier, statements on stateful objects must only be run once, and the state of an environment over time is the accumulation of such statements applied to it. (yes, we mention this fact again - it plays a key role!)</p>
<p>That means we cannot modify a Change entry in the Source Code once it is deployed, as otherwise the deploy tool will not know how to apply the difference. The modification must either be to add a new Change or to rollback/delete the change per the specifications of the tool (if supported).</p>
<p>To guard against such user actions, a hash of the Change text is stored in the Deploy Log. Upon subsequent releases, a hash is taken of the Change in Source Code to compare against the hash from the Deploy Log. (a hash is taken instead of storing the full text for space efficiency).</p>
<p>To summarize the hash difference behavior for Stateful Changes:</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th>Hash Comparison </th>
      
<th>Action</th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td>Hashes match in Source Code and Deploy Log </td>
      
<td>No action</td>
    </tr>
    
<tr class="a">
      
<td>Hashes value in Source Code, but not Deploy Log </td>
      
<td>Deploy Change</td>
    </tr>
    
<tr class="b">
      
<td>Hashes value in Deploy Log, but not Source Code </td>
      
<td>Exception - Source Code Change was removed improperly</td>
    </tr>
    
<tr class="a">
      
<td>Hashes differ between Source Code and Deploy Log </td>
      
<td>Exception - Source Code Change was changed improperly</td>
    </tr>
  </tbody>
</table>
<p>The following tables demonstrate an example:</p>

<table border="0" class="table table-striped">
    
<tr class="a">
        
<th align="center">Changeset Input</th>
        
<th align="center">Changeset Result</th>
        
<th align="center">Deploy Result</th>
    </tr>
    
<tr class="b">
        
<td colspan="3">Deploy #1 - new environment</td>
    </tr>
    
<tr class="a">
        
<td>
            
<table border="0" class="table table-striped">
                
<tr class="b">
                    
<th colspan="2">Source Code</th>
                    
<th></th>
                    
<th colspan="2">Deploy Log</th>
                </tr>
                
<tr class="a">
                    
<th>ChangeKey</th>
                    
<th>Hash</th>
                    
<th></th>
                    
<th>ChangeKey</th>
                    
<th>Hash</th>
                </tr>
                
<tr class="b">
                    
<td>change1</td>
                    
<td>abc</td>
                    
<td></td>
                    
<td></td>
                    
<td></td>
                </tr>
                
<tr class="a">
                    
<td>change2</td>
                    
<td>123</td>
                    
<td></td>
                    
<td></td>
                    
<td></td>
                </tr>
            </table>
        </td>
        
<td>change1 and change2 to be deployed</td>
        
<td>
            
<table border="0" class="table table-striped">
                
<tr class="a">
                    
<th colspan="2">Deploy Log</th>
                </tr>
                
<tr class="b">
                    
<th>ChangeKey</th>
                    
<th>Hash</th>
                </tr>
                
<tr class="a">
                    
<td>change1</td>
                    
<td>abc</td>
                </tr>
                
<tr class="b">
                    
<td>change2</td>
                    
<td>123</td>
                </tr>
            </table>
        </td>
    </tr>
    
<tr class="a">
        
<td colspan="3">Deploy #2 - new release on environment</td>
    </tr>
    
<tr class="b">
        
<td>
            
<table border="0" class="table table-striped">
                
<tr class="a">
                    
<th colspan="2">Source Code</th>
                    
<th></th>
                    
<th colspan="2">Deploy Log</th>
                </tr>
                
<tr class="b">
                    
<th>ChangeKey</th>
                    
<th>Hash</th>
                    
<th></th>
                    
<th>ChangeKey</th>
                    
<th>Hash</th>
                </tr>
                
<tr class="a">
                    
<td>change1</td>
                    
<td>abc</td>
                    
<td></td>
                    
<td>change1</td>
                    
<td>abc</td>
                </tr>
                
<tr class="b">
                    
<td>change2</td>
                    
<td>123</td>
                    
<td></td>
                    
<td>change2</td>
                    
<td>123</td>
                </tr>
                
<tr class="a">
                    
<td>mynewChange3</td>
                    
<td>qwerty</td>
                    
<td></td>
                    
<td></td>
                    
<td></td>
                </tr>
                
<tr class="b">
                    
<td>otherChange4</td>
                    
<td>uiop</td>
                    
<td></td>
                    
<td></td>
                    
<td></td>
                </tr>
            </table>
        </td>
        
<td>change1 and change2 to be deployed</td>
        
<td>
            
<table border="0" class="table table-striped">
                
<tr class="a">
                    
<th colspan="2">Deploy Log</th>
                </tr>
                
<tr class="b">
                    
<th>ChangeKey</th>
                    
<th>Hash</th>
                </tr>
                
<tr class="a">
                    
<td>change1</td>
                    
<td>abc</td>
                </tr>
                
<tr class="b">
                    
<td>change2</td>
                    
<td>123</td>
                </tr>
                
<tr class="a">
                    
<td>mynewChange3</td>
                    
<td>qwerty</td>
                </tr>
                
<tr class="b">
                    
<td>otherChange4</td>
                    
<td>uiop</td>
                </tr>
            </table>
        </td>
    </tr>
    
<tr class="a">
        
<td colspan="3">Deploy #3 - bad change; failure</td>
    </tr>
    
<tr class="b">
        
<td>
            
<table border="0" class="table table-striped">
                
<tr class="a">
                    
<th colspan="2">Source Code</th>
                    
<th></th>
                    
<th colspan="2">Deploy Log</th>
                </tr>
                
<tr class="b">
                    
<th>ChangeKey</th>
                    
<th>Hash</th>
                    
<th></th>
                    
<th>ChangeKey</th>
                    
<th>Hash</th>
                </tr>
                
<tr class="a">
                    
<td>change1</td>
                    
<td>abc</td>
                    
<td></td>
                    
<td>change1</td>
                    
<td>abc</td>
                </tr>
                
<tr class="b">
                    
<td>change2</td>
                    
<td>123</td>
                    
<td></td>
                    
<td>change2</td>
                    
<td>123</td>
                </tr>
                
<tr class="a">
                    
<td>mynewChange3</td>
                    
<td>
                        <font color="red">qwertyChanged</font>
                    </td>
                    
<td></td>
                    
<td>mynewChange3</td>
                    
<td>qwerty</td>
                </tr>
                
<tr class="b">
                    
<td>
                        <font color="red">
                            <s>otherChange4</s>
                        </font>
                    </td>
                    
<td>
                        <font color="red">
                            <s>uiop</s>
                        </font>
                    </td>
                    
<td></td>
                    
<td>otherChange4</td>
                    
<td>uiop</td>
                </tr>
            </table>
        </td>
        
<td>Failed validation: mynewChange3 hash changed, otherChange4 was removed</td>
        
<td>No changes applied</td>
    </tr>
</table></div>
<div class="section">
<h3><a name="Stateless_Changes:_Modifying_or_deleting_already_deployed_changes_IS_allowed"></a>Stateless Changes: Modifying or deleting already deployed changes IS allowed</h3>
<p>What about Stateless Changes?</p>

<ol style="list-style-type: decimal">
  
<li>The hash calculation logic remains the same as for Stateful Changes</li>
  
<li>Only the behavior on hash differences changes. Stateless Changes can be rerun (or dropped and added), so we have more flexibility here.</li>
</ol>
<p>To summarize the hash difference behavior for Stateful Changes:</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th>Hash Comparison </th>
      
<th>Action</th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td>Hashes match in Source Code and Deploy Log </td>
      
<td>No action</td>
    </tr>
    
<tr class="a">
      
<td>Hashes value in Source Code, but not Deploy Log </td>
      
<td>Deploy Change</td>
    </tr>
    
<tr class="b">
      
<td>Hashes value in Deploy Log, but not Source Code </td>
      
<td>Remove Change</td>
    </tr>
    
<tr class="a">
      
<td>Hashes differ between Source Code and Deploy Log </td>
      
<td>Re-deploy Change (drop/add if necessary)</td>
    </tr>
  </tbody>
</table></div></div>
<div class="section">
<h2><a name="Source_Code_Format"></a>Source Code Format</h2>
<p>We have the algorithm in abstract now - the question becomes: how best to represent the Changes in source code?</p>
<p>We present 2 alternatives - the first is what most DB tools support that works best with stateful objects, and the second is what Obevo uses to work with both stateful and stateless changes.</p>

<table class="table table-striped" border="1">
    <tbody>
        
<tr class="a">
            
<th valign="middle">
                <b>Methodology Name</b>
            </th>
            
<th valign="middle">
                <b>File per migration (used by most other tools)</b>
            </th>
            
<th>
                <b>File per DB object (used by Obevo)</b>
            </th>
        </tr>
        
<tr class="b">
            
<th>
                <b>Description</b>
            </th>
            
<td colspan="1">
                
<ul>
                    
<li>Most closely ties to how teams would do deployments manually</li>
                    
<li>Each file has the set of changes intended for the upcoming migration.</li>
                    
<li>Each file may span multiple database objects, and we can have multiple files for a migration.</li>
                </ul>

                Example:
                
<ul>
                    
<li>Original creation statements in version 1 (V1). Subsequent versions have followup updates</li>
                    
<li>The
                        <i>ChangeKey</i>
                        here is the file name that includes the version number
                    </li>
                </ul>
            </td>
            
<td colspan="1">
                
<ul>
                    
<li>Code/Changes for each class/object are kept in their own dedicated files/set of files</li>
                    
<li>An object requiring stateful changes can have many Changes defined in its file</li>
                    
<li>An object requiring stateless changes would only have one Change defined, which would be re-deployed for each change.</li>
                    
<li>This ties closely to how object-oriented languages maintain their code, e.g. Java having one-file-per-class</li>
                </ul>

                Example:
                
<ul>
                    
<li>The
                        <i>ChangeIdentity</i>
                        is the file name + &quot;//// CHANGE&quot; name for the subsection in the file (if applicable).
                    </li>
                    
<li>Note the stateless objects do not have &quot;//// CHANGE&quot; to denote multiple changes</li>
                </ul>
            </td>
        </tr>
        
<tr class="a">
            
<th><b>Example</b>:
            </th>
            
<td>
                
<table class="table table-striped" border="1">
                    <tbody>
                        
<tr class="b">
                            
<th>
                                <b>File Names</b>
                            </th>
                            
<th valign="middle">
                                <b>Content</b>
                            </th>
                        </tr>
                        
<tr class="a">
                            
<th>V1_baseline.sql</th>
                            
<td>
                                
<p>CREATE TABLE table1 (...)</p>
                                
<p></p>
                                
<p>CREATE TABLE table2 (...)</p>
                                
<p></p>
                                
<p>CREATE TABLE table3 (...)</p>
                                
<p></p>
                                
<p>CREATE VIEW view1 SELECT * FROM table2 inner join table3 ... where colA=1</p>
                            </td>
                        </tr>
                        
<tr class="b">
                            
<th>V2_table1ColAdd.sql</th>
                            
<td>
                                
<p>ALTER TABLE table1 ADD COLUMN colY</p>
                                
<p></p>
                                
<p>ALTER TABLE table1 ADD COLUMN colZ</p>
                            </td>
                        </tr>
                        
<tr class="a">
                            
<th>V2_addIndexes.sql</th>
                            
<td>
                                
<p>CREATE INDEX t1ind1 ON table1 (...)</p>
                                
<p></p>
                                
<p>CREATE INDEX t1ind2 ON table1 (...)</p>
                                
<p></p>
                                
<p>CREATE INDEX t2ind1 ON table2 (...)</p>
                            </td>
                        </tr>
                        
<tr class="b">
                            
<th>V3_repTableColAdds.sql</th>
                            
<td>
                                
<p>ALTER TABLE table1 ADD COLUMN colB</p>
                                
<p></p>
                                
<p>ALTER TABLE table3 ADD COLUMN colB</p>
                            </td>
                        </tr>
                        
<tr class="a">
                            
<th>V4_fkAdds.sql</th>
                            
<td>ALTER TABLE table3 ADD FOREIGN KEY ON (colB) REFERENCES table1 (colB)</td>
                        </tr>
                        
<tr class="b">
                            
<th>V4_viewFix1.sql</th>
                            
<td>
                                
<p>DROP VIEW view1</p>
                                
<p>CREATE VIEW view1 SELECT * FROM table2 inner join table3 ... where colA=2</p>
                            </td>
                        </tr>
                        
<tr class="a">
                            
<th>V5_viewFix2.sql</th>
                            
<td>
                                
<p>DROP VIEW view1</p>
                                
<p>CREATE VIEW view1 SELECT * FROM table2 inner join table3 ... where colA=3</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
            
<td style="padding: 2px;">
                
<table class="table table-striped" border="1">
                    <tbody>
                        
<tr class="a">
                            
<th>
                                <b>File Names</b>
                            </th>
                            
<th>
                                <b>Content</b>
                            </th>
                        </tr>
                        
<tr class="b">
                            
<th>table1.sql</th>
                            
<td>
                                
<p>//// CHANGE name=init</p>
                                
<p>CREATE TABLE table1 (...)</p>
                                
<p>//// CHANGE name=alter1</p>
                                
<p>ALTER TABLE table1 ADD COLUMN colY</p>
                                
<p>ALTER TABLE table1 ADD COLUMN colZ</p>
                                
<p>//// CHANGE name=index</p>
                                
<p>CREATE INDEX t1ind1 ON table1 (...)</p>
                                
<p>CREATE INDEX t1ind2 ON table1 (...)</p>
                                
<p>//// CHANGE name=alter2</p>
                                
<p>ALTER TABLE table1 ADD COLUMN colB</p>
                            </td>
                        </tr>
                        
<tr class="a">
                            
<th>table2.sql</th>
                            
<td>
                                
<p>//// CHANGE name=init</p>
                                
<p>CREATE TABLE table2 (...)</p>
                                
<p>//// CHANGE name=ind1</p>
                                
<p>CREATE INDEX t2ind1 ON table2 (...)</p>
                            </td>
                        </tr>
                        
<tr class="b">
                            
<th>table3.sql</th>
                            
<td>
                                
<p>//// CHANGE name=init</p>
                                
<p>CREATE TABLE table3 (...)</p>
                                
<p>//// CHANGE name=alter2</p>
                                
<p>ALTER TABLE table3 ADD COLUMN colB</p>
                                
<p>//// CHANGE name=fk1</p>
                                
<p>ALTER TABLE table3 ADD FOREIGN KEYON (colB) REFERENCES table1 (colB)</p>
                            </td>
                        </tr>
                        
<tr class="a">
                            
<th>view1.sql</th>
                            
<td>
                                
<p>
                                    <span style="text-decoration: line-through;">CREATE VIEW view1 SELECT * FROM table2 inner join table3 ... where colA=1 (edited on change 2)
                                    </span>
                                </p>
                                
<p>
                                    <span style="text-decoration: line-through;">CREATE VIEW view1 SELECT * FROM table2 inner join table3 ... where colA=2 (edited on change 3)
                                    </span>
                                </p>
                                
<p>CREATE VIEW view1 SELECT * FROM table2 inner join table3 ... where colA=3</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
        
<tr class="a">
            
<th>
                <b>Pros</b>
            </th>
            
<td style="padding: 2px;">
                
<ul>
                    
<li>Easy to adopt to initially as this is similar to the way teams would manually deploy db changes</li>
                    
<li>Similar changes across multiple tables can easily be done in one file (see the V2_addIndexes.sql example; such a use case is useful say if you forgot to apply a particular attribute to a db object)</li>
                    
<li>Easy to see which changes go into a particular version directly from the file system</li>
                </ul>
            </td>
            
<td style="padding: 2px;">
                
<ul>
                    
<li>Easier to understand the DB structure just from the file structure, as the two match (much like Java classes)</li>
                    
<li>File count will not grow significantly larger than the # of DB objects</li>
                    
<li>Editing stateless objects in place (following a model similar to that of Java code) is now possible</li>
                    
<li>More conducive to supporting the Level 7 maturity level (see below for more information)</li>
                    
<li>Re-baselining the SQLs will not lead to an excessively large single file, as we would have with the migration-based model.
                        
<ul>
                            
<li>In addition, re-baselining can be done on a per-table basis, instead of having to do it for the whole schema. This may be useful in case some tables are still actively developed in consecutive versions and others are not</li>
                        </ul>
                    </li>
                </ul>
            </td>
        </tr>
        
<tr class="b">
            
<th>
                <b>Cons</b>
            </th>
            
<td>
                
<ul>
                    
<li>Can lead to a cluttered and growing file system
                        
<ul>
                            
<li>As each migration is contained in a file, the number of files would continue to grow endlessly over time</li>
                            
<li>The toy example above only involves 4 database objects over 5 releases, and we have 7 files. Imagine how much more that will grow with the number of tables and versions that get added</li>
                        </ul>
                    </li>
                    
<li>Harder to baseline, and leads to a less-desirable baseline file
                        
<ul>
                            
<li>Baselining the DDLs would help avoid a cluttered file system</li>
                            
<li>However, that file itself would end up being very large, as it would contain all the database objects in the schema (you can see already how V1_baseline.sql is larger than the other tables).</li>
                            
<li>Such a file structure would not be as readable (certainly, we don't look to define all our Java classes in a single file)</li>
                        </ul>
                    </li>
                    
<li>Very unfriendly approach to use for stateless objects
                        
<ul>
                            
<li>Note the view1 example. We change the view 3 times (specifically the where clause), and even though it is a stateless objects, the &quot;migration&quot; methodology of the DB deployment tool forces us to duplicate the text across each file. Certainly it would be nice to edit this in place, similar to a Java class</li>
                        </ul>
                    </li>
                    
<li>This is less conducive to supporting the Level 7 Maturity Level mentioned below</li>
                </ul>
            </td>
            
<td style="padding: 2px;">
                
<ul>
                    
<li>Bulk changes to the schema could require changes to multiple files (e.g. note how the single V2_addIndexes.sql change in the migration-based model is now represented in two files)
                        
<ul>
                            
<li>However, note that the same consideration would apply for Java classes files regardless</li>
                            
<li>In addition, some concerns on applying bulk changes like permissions is mollified by the support that Obevo has to define grants in a central config file (i.e. no need to write grant statements for each table)</li>
                        </ul>
                    </li>
                    
<li>Cannot see in one file the changes that would be done for a particular version
                        
<ul>
                            
<li>However, note that the diffs across versions can still be viewed by comparing tags, similar to how you would do this for Java classes. (notice a pattern here in how we can maintain DB objects more like code?)</li>
                        </ul>
                    </li>
                </ul>
            </td>
        </tr>
    </tbody>
</table></div>
<div class="section">
<h2><a name="Sorting_Changes_in_the_file-per-object_format"></a>Sorting Changes in the file-per-object format</h2>
<p>The file-per-object format that Obevo chose has many benefits, but it adds some complexity in the tool&#x2019;s implementation, namely: how to define the order of the changes?</p>
<p>With the file-per-migration format, it is simpler to just order by the files; but the file-per-object format would likely require some ordering constraints across changes. In this section, we discuss how this is handled.</p>
<p>[Developer Guide note - this section is implemented in <b>com.gs.obevo.impl.graph.GraphEnricher]</b></p>
<p>Let&#x2019;s look at the source code example above, redrawn as a graph:</p>

<ol style="list-style-type: decimal">
  
<li>Each filled box represents a Change</li>
  
<li>The stateful table* files consist of many changes, and the stateless view* file only has a single change.</li>
  
<li>The arrows represent order dependencies among the changes, notably:</li>
  
<li>view1 depends on table2 and table3 per the SQL definition (an explicit code dependency)</li>
  
<li>table3&#x2019;s foreign key depends on table1 to be created (an explicit code dependency)</li>
  
<li>The Changes listed within a stateful object must be done in order (an implicit dependency based on the order in the file)</li>
  
<li>Note that changes not related via arrows (whether directly or transitively) don&#x2019;t have any dependency order, e.g. table1.init and table2.init can be executed in any order.</li>
</ol>
<p><img src="images/dependency-graph.jpg" alt="Dependency Graph" /></p>
<p>Given that graph, an acceptable deployment order can be obtained using<a class="externalLink" href="https://en.wikipedia.org/wiki/Topological_sorting">topological sort</a>. Please read the link for more information.</p>
<p>[Developer Guide note - the topological sorting is implemented (with the help of<a class="externalLink" href="http://jgrapht.org/">JGraphT</a>) in <b>com.gs.obevo.impl.graph.GraphSorter]</b></p>
<p>For the example above, we have a number of acceptable topological sorts:</p>

<ol style="list-style-type: decimal">
  
<li>table1.init, table1.alter1, table1.index, table1.alter2, table3.init, table3.alter2, table3.fk1, table2.init, table2.ind1, view1</li>
  
<li>table2.init, table2.ind1, table3.init, table3.alter2, table1.init, table1.alter1, table1.index, table1.alter2, table3.fk1, view1</li>
</ol>
<p>For easier supportability by clients, we will tune the topological sorting algorithm to give a consistent sorting.</p></div>
<div class="section">
<h2><a name="Defining_and_discovering_dependencies_in_Source_Code"></a>Defining and discovering dependencies in Source Code</h2>
<p>One detail left for this algorithm - how is the dependency graph created from the source code? Specifically the explicit code dependencies, which require some sort of parsing of the code. Parsing code is not a trivial problem; to do it correctly, we would need ASTs for the coding language of the text, and that may not be easily avaiable or easy to implement.</p>
<p><b>Part 1:</b> The simplest methology is to avoid parsing entirely by defining a metadata attribute on each Change for the dependencies. This would technically work, however it will not scale well for developers if there are hundreds (or thousands) of code files to maintain. But this method will still prove useful; we will com back to this.</p>
<p><b>Part 2:</b> We can discover the dependencies in text using a rudimentary technique:</p>

<ol style="list-style-type: decimal">
  
<li>We have the object names (based on the directory structure) and the text of the code</li>
  
<li>For each Change, search for references to those object names. Whichever object names are found in the text are counted as dependencies.</li>
</ol>
<p>[Developer Guide note - this technique is implemented in <b>com.gs.obevo.impl.text.TextDependencyExtractor]</b></p>
<p>From the example above:</p>

<ol style="list-style-type: decimal">
  
<li>The object name list is: table1, table2, table3, view1</li>
  
<li>The text for view1 is as follows, with the obect names in red and italicized</li>
</ol>

<table class="table table-striped" border="1">
    
<tr class="a">
        
<td>CREATE VIEW
            <font color="red">
                <i>view1</i>
            </font>
            SELECT * FROM
            <font color="red">
                <i>table2</i>
            </font>
            inner join
            <font color="red">
                <i>table3</i>
            </font>
            ... where colA=3
        </td>
    </tr>
</table>

<ol style="list-style-type: decimal">
  
<li>Excluding the object&#x2019;s own name (view1), we find that table2 and table3 are dependencies.</li>
</ol>
<p><b>Part 3:</b> What if our rudimentary technique doesn&#x2019;t work? We may find false positives or false negatives.</p>
<p>In this case, fall back to the metadata tag option mentioned in part 1. We either let clients:</p>

<ol style="list-style-type: decimal">
  
<li>Override the programmatic calculation by defining their list</li>
  
<li>Supplement the programmatic calculation by specifying dependencies to add (fixing the false negatives)</li>
  
<li>Supplement the programmatic calculation by specifying dependencies to remove (fixing the false positives)</li>
</ol></div>
<div class="section">
<h2><a name="Putting_it_together_-_integrating_DB_Deployments_and_Other_Platforms"></a>Putting it together - integrating DB Deployments and Other Platforms</h2>
<p>Thus far, we have not had any specific DB or SQL imprints in the algorithms (The text parsing algorithm could work with any language).</p>
<p>The points where DB-specific (or any other platform-specific) log would go are:</p>

<ul>
  
<li>&#x201c;Apply Changeset to Platform&#x201d; - this point in the algorithm takes the Change as input; how to actually apply the change is platform-specific</li>
  
<li>Deploy Log implementation - this should ideally co-exist w/ the environment (e.g. a table in the DB for DB platforms), but that is not an absolute requirement.</li>
  
<li>&#x201c;Read Changes from Source Code&#x201d; - the structure to impose for a platform on users can be defined as an implementation desires.</li>
  
<li>&#x201c;Calculate Changeset&#x201d; and Discovering Dependencies - there are a few minor details for each platform implementation to fill in (e.g. handling case-sensitivity)</li>
</ul>
<p>[Developer Guide note - <b>com.gs.obevo.api.platform.Platform</b> and <b>com.gs.obevo.api.platform.ChangeType</b> classes are the key interfaces to implement to customize the behavior for each platform.]</p></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2017&#x2013;2020
<a href="http://www.goldmansachs.com/">Goldman Sachs</a>.
All rights reserved.</p>
        </div>
        </div>
    </footer>
    </body>
</html>
