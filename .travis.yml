sudo: required

language: java
jdk: openjdk8

services:
- docker

env:
  global:
    - JAVA7_HOME=/usr/lib/jvm/java-7-openjdk-amd64
    - MAVEN_OPTS="-Dmaven.repo.local=$HOME/.m2/repository -Xmx2g -Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss:SSS -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn"

before_install:
  - docker pull ibmcom/db2express-c
  # Start the container and store the container ID for reference
  - CONTAINER_ID=$(docker run -d -i -t -p 50000:50000 -e DB2INST1_PASSWORD=db2inst1-pwd -e LICENSE=accept ibmcom/db2express-c:latest db2start)
  # Create the database (may take a few seconds)
  - docker exec -it $CONTAINER_ID bash -c "su - db2inst1 -c 'db2 create db dbdeploy'"
  # Log into the database to subsequently run more actions
  - docker exec -it $CONTAINER_ID bash -c "su - db2inst1 -c 'db2 connect to dbdeploy; db2 create schema dbdeploy01; db2 create schema dbdeploy02; db2 create schema dbdeploy03'"
  - DB2_VERSION=10.5.0.5
  - DB2_GROUP=com.ibm.db2
  - DB2_ARTIFACTS=db2jcc db2jcc4 db2jcc_license_cu
  - DB2_JAVA_BINARY_HOME=/home/db2inst1/sqllib/java
  - for ARTIFACT in $DB2_ARTIFACTS; do
    echo "Working on artifact $ARTIFACT"
    docker cp $CONTAINER_ID:$DB2_JAVA_BINARY_HOME/$ARTIFACT.jar $TMPDIR/$ARTIFACT.jar
    mvn install:install-file -DgroupId=$DB2_GROUP -DartifactId=$ARTIFACT -Dversion=$DB2_VERSION -Dfile=$TMPDIR/$ARTIFACT.jar -Dpackaging=jar -DgeneratePom=true
    rm -f $TMPDIR/$ARTIFACT.jar
    done


#  - docker run -d -p 127.0.0.1:80:4567 carlad/sinatra /bin/sh -c "cd /root/sinatra; bundle exec foreman start;"
#  - docker ps -a
#  - docker run carlad/sinatra /bin/sh -c "cd /root/sinatra; bundle exec rake test"

# Note: Travis already runs maven test as part of its run script. We add the verify step to get integration tests: https://docs.travis-ci.com/user/languages/java/
script: mvn -Dtest=noUnitTestsInThisPhase -DfailIfNoTests=false verify
